## HTTP

> HTTP 是一个在计算机世界里专门在两点之前传输文字、图片、音频、视频等超文本数据的约定和规范；

### 特点

1. 灵活可扩展：
   - 在语法上只规定了基本格式，空格分隔单词，换行分隔字段等；
   - 传输形式上不仅可以传输文本，还可以传输图片、视频等任意数据；
2. 请求-应答模式：
   - 一方发送消息，一方接受消息，或者做出响应等；
3. 可靠传输：
   - HTTP 是基于 TCP / IP，因此把这一特性继承了下来；
4. 无状态；

### 缺点

1. 无状态：有时需要保存信息，比如需要保留用户信息等，另外一方面，无状态也会减少网络开销，比如直播等；
2. 明文传输：即协议里的报文（主要指头部）不使用二进制数据，而是文本形式，让 http 报文信息暴露给外部；
3. 队头阻塞：当 http 开启长连接时，共用一个 TCP 连接，当某个请求时间过长的时候，其他请求只能处于阻塞状态；

## http 0.9

1991年，原型版本，只有一个命令 GET，只支持纯文本内容，该版本已过时；

## http 1.0

1. 任何格式的内容都可以发送，可以传输文字、图片、视频、二进制等文件；
2. 除了 GET 命令，还引入了 POST 和 HEAD 命令；
3. http 请求和回应的格式改变，除了数据部分，每次通信都必须包括头信息（HTTP header）,用来描述一些元数据；
4. 只使用 header 的 If-Modified-Since 和 Expires 作为缓存失效的标准；
5. 不支持断点续传，每次都会传送全部的页面和数据；
6. 通常每台计算机只能绑定一个 IP ,所以请求消息中的 URL 没有传递主机名（hostname）;

## http1.1

1. 引入持久连接和 CDN 域名的分片机制：即 TCP 连接默认不关闭，可以被多个请求复用，不用声明 Connection：keep-alive，长连接的时长可以通过请求头中的 keep-alive 来设置；
2. 引入管道机制：即在同一个 TCP 连接中，客户端可以同时发送多个请求，进一步改进了 HTTP 协议的效率；
3. 支持断点续传：通过使用请求头中的 Range 来实现；
4. 使用了虚拟网络，在一台物理服务器上可以存在多个虚拟主机，并且它们共享一个 IP 地址；
5. 新增了 E-tag、If-Unmodified-Since、If-Match、If-None-Match 等缓存控制标头来控制缓存失效；
6. 新增方法：PUT、PATCH 、OPTIONS、DELETE；

## http1.x 存在的问题

1. 在传输数据过程中，所有内容都是明文，客户端和服务器端都无法验证对方的身份，无法保证数据的安全性；
2. 队头阻塞：HTTP/1.1 版本默认允许复用 TCP 连接，但是在同一个 TCP 连接中，所以通信是按次序进行，服务器在处理完一个回应后，才会继续去处理下一个；
3. 协议规定客户端对同一域的并发连接最多只能2个；
4. http/1.x 版本支持Keep-alive，用此方案来弥补创建多次连接产生的延迟，但是同样会给服务器带来压力，对于单文件被不断请求的服务，Keep-alive会极大影响性能，因为它在文件被请求之后还保持了不必要的连接很长时间；
5. 基于文本协议，请求和响应头信息非常大，并且无法压缩；
6. 不能控制响应的优先级，必须按照请求顺序响应；
7. 只能单向请求，也就是客户端请求什么，服务器只能返回什么；

## http 2.0

> http2 是超文本传输协议的第二版，相比 http1 协议的文本传输格式，http2 是以二进制的格式进行数据传输的，具有更小的体积以及负载；

### 基础概念

- 流：已建立的连接上的双向字节流；
- 消息：与逻辑消息对应的完整的一系列数据帧；
- 帧：http2 通信的最小单位，每个帧包含首部，至少也会标识出当前帧所属的流；

### 二进制分帧

之前是明文传输，不方便计算机解析，存在空格或其他字符，很难判断消息的起始和结束； HTTP 2 采用二进制格式，全部传输 01串，便于机器解码，同时有更小的传输体积意味着更低的负载；

一个报文格式就被拆分一个个二进制帧，用 Headers 帧存放头部， Data 帧存放请求数据；这样就是一堆乱序的二进制帧，它们不存在先后关系，因此不需要排队，解决了 HTTP 队头阻塞的问题；

对于乱序的二进制帧，是如何组装成对应的报文：

1. 乱序指的是不同 ID 的 Stream 是乱序的，对于同一个 Stream ID 的帧是按顺序传输的；
2. 接收方收到二进制帧后，将相同的 Stream ID 组装成完整的请求报文和响应报文；
3. 二进制帧中有一些字段，控制着优先级和流量控制等功能，就可以设置数据帧的优先级，让服务器处理重要资源，优化用户体验；

### 多路复用

HTTP 1.x中，如果想并发多个请求，必须使用多个 TCP 连接，且浏览器为了控制资源，会对单个域名有 6-8个 TCP 连接的请求限制；

HTTP2 中：

1. 同域名下所有通信都在单个连接上完成；
2. 单个连接可以承载任意数量的双向数据流；
3. 数据流以消息的形式发送，消息由一个或多个帧组成，多个帧之间可以乱序发送，因为根据帧首部的流标识可以重新组装，也就是 Stream ID，这样接收方就能从乱序的二进制帧中选择 ID 相同的帧，按照顺序组装成请求/响应报文；

### 优先级和依赖关系 

每个流都包含一个优先级，它用来告诉对端哪个流更重要，当资源有限的时候，服务器会根据优先级来选择应该先发送哪些流；

借助 PRIORITY 帧，客户端可以告知服务器当前流依赖于其它哪个流，该功能能让客户端建立一个优先级“树”，所有“子流”会依赖于“父流”的传输完成情况；

优先级和依赖关系可以在传输过程中被动态的改变。这样当用户滚动一个全是图片的页面的时候，浏览器就能够指定哪个图片拥有更高的优先级。或者是在你切换标签页的时候，浏览器可以提升新切换到页面所包含流的优先级。

### 头部压缩

因为 http 协议本身是无状态的，所以每个请求之前互不关联，每个请求都需要携带服务器所需要的信息；

在 http2 之前一般使用 Cookie 头，服务器 session 等方式模拟出状态，但是这样的缺点就是每个请求都要携带大量的重复信息并且无法压缩，这是一个巨大的带宽浪费；

http2 增加了两个特性解决上面的问题：

- HPACK：专门为头部压缩设计的算法，还被指定成单独的草案中；

- 首部表：

  1. http2 在客户端和服务器端使用“首部表”来跟踪和存储之前发送的键值对，对于相同的数据，不再通过每次请求和响应再次发送；
  2. 通信期间几乎不会改变的通用键值对（用户代理、可接受的媒体类型等）只需要发送一次；
  3. 如果首部发生变化，那么只需要发送变化数据在 Headers 帧里面，新增或者修改的首部帧会被追加到“首部表”；

  ![header-table](https://user-gold-cdn.xitu.io/2018/4/10/162b00acb5991f30?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

### 服务器推送

> 浏览器发送一个请求，服务器主动向浏览器推送与这个请求相关的资源，这样浏览器就不用发起后续请求；

相较 http1.1 的优势：

1. 推送资源可以由不同页面共享；
2. 服务器可以按照优先级推送资源；
3. 客户端可以缓存推送的资源；
4. 客户端可以拒收推送过来的资源，如果不需要的话，客户端可以发送一个 RST_STREAM 帧来中止推送；

### 可重置消息

在 http1.x 中有一个问题：当一个含有确切值的 Content-lengt 的 http 消息被送出之后，就很难中断它了，通常可以断开整个TCP 连接，但是这样导致的代价就是需要通过三次握手来重新建立一个新的 TCP 连接；

在 http2 里，可以通过发送 RST_STRWAM 帧来实现这个需求，从而避免浪费带宽和中断已有的连接；

### 流量控制

每个 http2 流都拥有自己的公示的流量窗口，它可以限制另一端发送数据；
对于每个流来说，两端都必须告诉对方自己还有足够的空间来处理新的数据，而在窗口被放大前，另一端只被允许发送这么多数据；
只有数据帧会受到流量控制；

### 优势

1. 更小的传输体积，更小或者省略重复的头消息；
2. 突破原有的 TCP 连接并发限制，使用一个 TCP 连接即可实现多请求并发，单连接也能减轻服务端的压力（更少的内存和CPU使用）；
3. 解决 HOLB 线头问题，慢的请求或者先发送的请求不会阻塞其它的请求返回；
4. 结合 CDN 提供实时性更高，延迟更低的内容分发代理服务，大大减少白屏时间；
5. 数据传输优先级可控，使网站可以实现更灵活和强大的页面控制；
6. 能在不中断 TCP 连接的情况下停止（重置）数据的发送；

## https

> https 协议是承载在 TCP 协议上的，在 http 和 tcp 之间添加一个安全层协议，SSL 或者 TSL （ssl/tls 协议传输，包含证书，卸载，流量转发，负载均衡，页面适配，浏览器适配，refer传递等）；

### 与 http 的对比

1. 传输方式：
   - http：明文传输，网站或者相关服务与用户之间的数据交互无加密，容易被监听、篡改；
   - https：在 http 加入了 ssl 层，用于数据加密传输；
2. 身份认证：
   - http：无任何身份认证，用户无法通过 http 辨认出网站的真实身份；
   - https：经过 CA 多重认证，包含域名管理权限认证等；
3. 成本：
   - http：无任何使用成本，所有网站默认是 http 模式；
   - https：需要成本，需要申请 SSL 证书来实现 https；
4. 连接端口：
   - http：80 端口；
   - https：443 端口；

## Http 的请求方法

1.  GET 方法：发送一个请求来获取服务器上的某些资源；
2.  POST 方法：向 URL 指定的资源提交数据或者附加新的数据；
3.  PUT 方法：和 POST 方法一样，可以向服务器提交数据，但是也有不同， PUT 指定了资源在服务器的位置，POST 没有；
4.  HEAD 方法：请求页面的首部；
5.  DELETE 方法：删除服务器上的某些资源；
6.  OPTIONS 方法：它用于获取当前 URL 所支持的方法，如果请求成功，在 Allow 的头包含类似 GET , POST 等信息；
7.  TRACE 方法：用于激发一个远程的，应用层的请求消息回路；
8.  CONNECT 方法：把请求连接转换到 TCP / IP 通道；



