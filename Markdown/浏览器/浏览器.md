## 浏览器组成

1. 用户界面：地址栏、前进/后退按钮、书签菜单等；
2. 浏览器引擎：在用户界面和呈现引擎之间传送指令；
3. 呈现引擎：负责显现请求的内容，如果请求的内容是HTML，它就是负责解析HTML和CSS的内容，并将解析后的内容显示在屏幕上；
4. 网络：用于网络调用，比如HTTP请求；
5. 用户界面后端：用于绘制基本的窗口小部件，比如组合框和窗口；
6. Javascript解释器：用于解析和执行Javascript代码 ；
7. 数据存储：这是持久层；浏览器需要在硬盘上保存各种数据，例如Cookie；

## 单线程与异步

1. JS 的单线程是指一个浏览器进程中只有一个 JS 的执行线程，同一时刻只会有一段代码在执行；
2. 异步机制是浏览器的两个或以上常驻线程共同完成的；比如异步请求由JS 执行线程和事件触发线程共同完成；
  - JS 执行线程发起异步请求：浏览器会开启一个HTTP请求线程来执行请求，这时 JS 的任务完成，继续执行线程队列中剩下任务；
  - 在未来某一时刻事件触发线程监视到之前发起的 HTTP 请求已完成，它就会把完成事件插入到 JS 执行队列的尾部等待 JS 处理；
3. JS单线程与异步更多是浏览器行为，之间不冲突；

## 输入URL到页面呈现

1. 用户输入：在当前页面即将替换成新的页面的时候，浏览器给了当前页面一次执行 beforeunload 事件的机会，允许在页面退出之前执行行一些操作；
2. URL 请求过程：

   - 网络进程查找本地缓存是否缓存了该资源，如果缓存直接使用；

   - 如果没有在缓存中查找到资源，进入网络请求流程：

     1. DNS 解析：浏览器缓存，hosts文件，本地dns服务器、找根服务器：找了根服务器后，根服务器会根据请求的域名，开始递归+迭代解析，得到查询结果；本地dns服务器，把最终的解析结果，返回给客户端；
     2. 建立TCP连接；通过三次握手建立客户端和服务器之前的连接；
     3. 数据传输；
     4. 通过四次挥手来断开连接；

3. 准备渲染进程：Chrome 会为每个页面分配一个渲染进程，每打开一个新页面就会配套创建一个新的渲染进程；
4. 渲染阶段：文件解码成功后会开始渲染流程；
   - 根据 HTML  构建 DOM树，有 CSS 就构建 CSSOM 树；
   - 如果遇到 script 标签，会判断是否存在 async 或者 defer，async 会并行下载并执行 js，defer 会先下载文件，然后等待 HTML 解析完成后顺序执行；如果以上都没有，就会阻塞渲染流程直到 JS 执行完毕；
   - CSSOM 和 DOM 树构建完成后会开始生成 Render 树，这一步是确定页面元素的布局、样式等；
   - 在生成 Render 树的过程中，浏览器就开始调用 GPU 绘制，合成图层，将内容显示在屏幕上；

## CSS动画比 JS 高效

1.  不占用JS主线程；
2.  可以利用硬件加速；
3.  浏览器可对动画做优化（元素不可见时不动画减少对FPS影响）；

## preload

1. Preload 是一个新的控制特定资源如何被加载的新的 Web 标准，这个指令可以在 link 中使用，比如 link rel="preload"；
2. 最好使用 preload 来加载你最重要的资源，比如图像，CSS，JavaScript 和字体文件；
3. 不要与浏览器预加载混淆，浏览器预加载只预先加载在HTML中声明的资源。preload 指令事实上克服了这个限制并且允许预加载在 CSS 和JavaScript 中定义的资源，并允许决定何时应用每个资源；

4. preload 并不会阻塞 window 的 onload 事件；

### 优势

1. 允许浏览器来设定资源加载的优先级因此可以允许前端开发者来优化指定资源的加载；

2. 赋予浏览器决定资源类型的能力，因此它能分辨这个资源在以后是否可以重复利用；

3. 浏览器可以通过指定 as 属性来决定这个请求是否符合 content security policy；

   ```javascript
   <link rel="preload" href="/css/mystyles.css" as="style">
   ```

4. 如果预加载需要 CORS 的跨域请求，那么也要加上 crossorigin 的属性。

   ```javascript
   <link rel="preload" href="https://example.com/fonts/font.woff" as="font" crossorigin>
   ```

## prefetch

> Prefetch 是一个低优先级的资源提示，允许浏览器在后台（空闲时）获取将来可能用得到的资源，并且将他们存储在浏览器的缓存中;
>

一旦一个页面加载完毕就会开始下载其他的资源，然后当用户点击了一个带有 prefetch 的连接，它将可以立刻从缓存中加载内容；

### Link Prefetching

> link prefetching 允许浏览器获取资源并将他们存储在缓存中；

浏览器会寻找 HTML `<link>` 元素中的 prefetch 或者 HTTP 头中如下的 Link：

```javascript
HTML: <link rel="prefetch" href="/uploads/images/pic.png">
HTTP Header: Link: </uploads/images/pic.png>; rel=prefetch
```
### DNS Prefetching

> DNS prefetching 允许浏览器在用户浏览页面时在后台运行 DNS 的解析；

这样DNS 的解析在用户点击一个链接时已经完成，所以可以减少延迟；

```javascript
 <link rel="dns-prefetch" href="//cdn.domain.com">
```
### prerendering

Prerendering 和 prefetching 非常相似，它们都优化了可能导航到的下一页上的资源的加载，区别是 prerendering 在后台渲染了整个页面，整个页面所有的资源；

```javascript
<link rel="prerender" href="https://www.keycdn.com">
```